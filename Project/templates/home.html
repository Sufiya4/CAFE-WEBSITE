<!DOCTYPE html>
<html>
<head>
    <title>QuickPark - Home</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/home.css') }}">
    <style>
        /* Your custom styles */
        .selected-link {
            font-weight: bold;
        }
        .available {
            background-color: #c5e1a5;
        }

        .occupied {
            background-color: #e57373;
        }
        .plot.available{
            background-color: #c5e1a5;
        }
        .plot.occupied{
            background-color: #e57373;
        }
         /* Updated styles for Booking History Section */
         .Current-bookings {
            position: fixed;
            bottom: -350px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background-color: #fff;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
            display: none;
            border-radius: 5px 5px 0 0;
        }

        .Current-bookings{
            bottom: 0;
        }

        .Current-bookings h2{
            margin-bottom: 10px;
            background-color: #0e3310;
            color: #fff;
            padding: 10px;
            font-weight: bold;
            border-radius: 5px 5px 0 0;
        }

        .Current-bookings-table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
        }

        .Current-bookings-table th, .Current-bookings-table td {
            padding: 12px;
            border-bottom: 1px solid #ccc;
        }

        .Current-bookings-table th {
            background-color: #0e3310;
            color: #fff;
            font-weight: bold;
        }

        .Current-bookings-table tr:hover {
            background-color: #f2f2f2;
        }

        .Current-bookings-table tr:last-child td {
            border-bottom: none;
        }

        .toggle-current-bookings {
            text-align: center;
            margin-top: 20px;
        }

        .toggle-current-bookings button {
            background-color: #0056b3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }

        .toggle-current-bookings button:hover {
                background-color: #0056b3;
        }
        .arrow {
            display: inline-block;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-bottom: 6px solid white; /* Arrow color */
            margin-left: 6px; /* Adjust as needed */
            transition: transform 0.3s ease;
        }

        .arrow.collapsed {
                transform: rotate(180deg);
        }
        #upper-right-image {
            position: fixed;
            border: 2px solid #01003f;
            top: 6px;
            right: 20px;
            width: 80px; /* Adjust the width as needed */
            height: auto; /* This will maintain the aspect ratio of the image */
            z-index: 9999; /* Use a high z-index to ensure the image is above other elements */
        }
    </style>
</head>
<body>
    <img src="https://static.vecteezy.com/system/resources/previews/000/623/239/original/auto-car-logo-template-vector-icon.jpg" alt="Image" id="upper-right-image">
    <h1>Welcome To QuickPark</h1>
    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Book Plot</h2>
            <p>Do you want to book Plot <span id="selected-plot-id"></span> for the selected date and time?</p>
            <button id="confirm-booking">Confirm Booking</button>
            <button id="backButton">Back to Home</button>
        </div>
    </div>

    <div class="toggle-button" onclick="toggleMenu()">
        <div class="bar"></div>
        <div class="bar"></div>
        <div class="bar"></div>
    </div>

    <div class="sidebar" id="sidebar">
        <ul class="menu">
            <li><a href="#" class="selected-link">Home</a></li>
            <li><a href="/profile">Profile</a></li>
            <li><a href="/booking_history">Booking History</a></li>
            <li><a href = "/cancel_booking">Cancel Booking</a></li>
        </ul>
    </div>

    <div class="booking-controls">
        <label for="Location">Location</label>
        <select id="Location">
            <option value="Mantri Square Mall">Mantri Square Mall</option>
        </select>
        <label for="Parking-Type">Parking-Type</label>
        <select id="Parking-Type">
            <option value="Car">4-wheeler</option>
        </select>

        <label for="booking-date">Date:</label>
        <select id="booking-date" required></select>

        <label for="booking-time">Time:</label>
        <select id="booking-time" required></select>

        <label for="booking-hours">Number of Hours:</label>
        <input type="number" id="booking-hours" min="1" max="24" required>

        <button id="show-plots-button" style="color: white;" border="none">Show Available Plots</button>
    </div>

    <!-- Payment Page Placeholder (to be displayed when booking is successful) -->
    <div id="paymentPage" class="payment-page" style="display: none;">
        <h2>Payment</h2>
        <form id="paymentForm">
            <!-- Payment form fields and details go here -->
            <button type="button" id="payNowButton">Pay Now</button>
        </form>
    </div>
    <div class="parking-lot">
        <!-- Dynamic parking plots generated here -->
        {% for plot in plots %}
        <div
            id="{{ plot.plot_id }}"
            class="plot"
            data-plot-id="{{ plot.plot_id }}"
        >
            <div class="plot-name">{{ plot.name }}</div>
            <div class="timer"></div>
        </div>
        {% endfor %}
    </div>

    <div id="Current_bookings" class="Current-bookings" style="display: none;">
        <h2>Current Bookings <span id="current-bookings-arrow" class="arrow"></span></h2>
        <table class="current-bookings-table">
            <tr>
                <th>Plot</th>
                <th>Booking Start Time</th>
                <th>Booking End Time</th>
                <th>Total Amount</th>
            </tr>
            <!-- Sample current bookings rows (to be updated dynamically using JavaScript) -->
        </table>
   </div>
    <!--  <div class="toggle-current-bookings">
        <button id="current-bookings-toggle">Show Current Bookings</button>
    </div> -->


    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const plots = document.querySelectorAll('.plot');
            const homeLink = document.querySelector('.menu li:first-child a');
            const bookingDateSelect = document.getElementById('booking-date');
            const bookingControls = document.querySelector('.booking-controls');


            function updateAvailableTimeIntervals(selectedDate) {
                fetch('/available_time_intervals', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ selectedDate: selectedDate })
                })
                .then(response => response.json())
                .then(data => {
                    const timeIntervalSelect = document.getElementById('booking-time');
                    timeIntervalSelect.innerHTML = data.time_intervals.map(interval => `<option value="${interval}">${interval}</option>`).join('');
                })
                .catch(error => {
                    console.error('Error fetching available time intervals:', error);
                });
            }

            bookingDateSelect.addEventListener('input', function () {
                const selectedDate = bookingDateSelect.value;
                if (!selectedDate) {
                    // If the user leaves the date field empty, default to the present date
                    const today = new Date();
                    const todayString = today.toISOString().split('T')[0];
                    updateAvailableTimeIntervals(todayString);
                } else {
                    // Otherwise, update based on the selected date
                    updateAvailableTimeIntervals(selectedDate);
                }
            });

            // Initialize the date field with the current date when the page loads
            const today = new Date();
            const todayString = today.toISOString().split('T')[0];
            bookingDateSelect.value = todayString;

            // Trigger the initial update of time intervals based on the current date
            updateAvailableTimeIntervals(todayString);

            // Helper function to update the timers for booked plots
            function updateTimers() {
                const currentTime = new Date().getTime();

                plots.forEach(plot => {
                    if (plot.classList.contains('selected')) {
                        const bookingTime = parseInt(plot.dataset.startTime);
                        const timeDifference = currentTime - bookingTime;

                        const minutes = Math.floor(timeDifference / 1000 / 60);
                        const seconds = Math.floor((timeDifference / 1000) % 60);
                        plot.querySelector('.timer').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                        // If the booking has ended, stop the timer for this plot
                        if (timeDifference >= (15 * 60 * 1000)) {
                            clearInterval(plot.dataset.timerInterval);
                        }
                    }
                });
            }

            fetch('/available_dates')
                .then(response => response.json())
                .then(data => {
                    console.log(data);
                    updateAvailableDates(data.available_dates);
                })
                .catch(error => {
                    console.error('Error fetching available dates:', error);
                });

            // Helper function to update available dates
            function updateAvailableDates(dates) {
                bookingDateSelect.innerHTML = dates.map(date => `<option value="${date}">${date}</option>`).join('');
            }

            // Add event listeners for showing and hiding the modal
            plots.forEach(plot => {
                plot.addEventListener('click', function () {
                    if (plot.classList.contains('available')) {
                        // Show the modal and populate the selected plot id
                        modal.style.display = 'block';
                        document.getElementById('selected-plot-id').textContent = plot.dataset.plotId;
                    }
                    else {
                        alert('This slot is not available for booking.');
                    }
                });
            });


            // Handle "Show Available Plots" button click
            const showPlotsButton = document.getElementById('show-plots-button');
            showPlotsButton.addEventListener('click', function () {
                const bookingDate = bookingDateSelect.value;
                const bookingTime = document.getElementById('booking-time').value;
                const bookingHours = document.getElementById('booking-hours').value;

                if (!bookingDate || !bookingTime || !bookingHours) {
                    alert('Please fill in all booking details.');
                } else {
                    // Call your backend API to fetch availability data and update plot colors
                    const requestData = {
                        bookingDate: bookingDate,
                        bookingTime: bookingTime,
                        bookingHours: bookingHours
                    };

                    fetch('/get_plot_availability', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    })
                    .then(response => response.json())
                    .then(data => {
                        const plotAvailability = data.plotAvailability;  // Updated data structure
                        updateParkingPlots(plotAvailability);
                        const parkingLot = document.querySelector('.parking-lot');
                        parkingLot.style.display = 'grid';
                        // Adjust the button position
                        bookingControls.style.marginTop = '20px';
                    })
                    .catch(error => {
                        console.error('Error fetching plot availability:', error);
                    });
                }
            });

            // Function to update parking plots based on availability data
            function updateParkingPlots(plotAvailability) {
                for (const plotId in plotAvailability) {
                    const plot = document.getElementById(plotId);
                    if (plot) {
                        const isAvailable = plotAvailability[plotId];
                        plot.classList.remove('available', 'occupied');
                        plot.classList.add(isAvailable ? 'available' : 'occupied');
                    }
                }
            }

            // Function to toggle the sidebar
            function toggleMenu() {
                const sidebar = document.getElementById('sidebar');
                sidebar.classList.toggle('active');
            }
            // Get the modal and the span element for closing
            const modal = document.getElementById('myModal');
            const span = document.getElementsByClassName('close')[0];
            const backButton = document.getElementById('backButton');

            // Add event listeners for showing and hiding the modal
            plots.forEach(plot => {
                plot.addEventListener('click', function () {
                    if (plot.classList.contains('available')) {
                        // Show the modal and populate the selected plot id
                        modal.style.display = 'block';
                        document.getElementById('selected-plot-id').textContent = plot.dataset.plotId;
                    } else {
                        alert('This slot is not available for booking.');
                    }
                });
            });

            // Close the modal when the user clicks on the close button or back button
            function closeModal() {
                modal.style.display = 'none';
            }

            span.addEventListener('click', closeModal);
            backButton.addEventListener('click', closeModal);

            // Confirm booking and redirect to payment page
            const confirmButton = document.getElementById('confirm-booking');
            confirmButton.addEventListener('click', function () {
                // Get the selected plot id
                const selectedPlotId = document.getElementById('selected-plot-id').textContent;
                const urlParams = new URLSearchParams({ plot_id: selectedPlotId });
                window.location.href = '/payment?' + urlParams.toString();
            });
            // ... (rest of the code)
            // Call the function to fetch user's current bookings and populate the table

            // Function to populate the current bookings table with data
            function populateCurrentBookingsTable(bookings) {
                const table = document.querySelector('.current-bookings-table'); // Select the table element
                if (bookings.length === 0) {
                    table.innerHTML = `
                        <tr>
                            <th colspan="4">No current bookings</th>
                        </tr>
                `;
                } else {
                    table.innerHTML = `
                        <tr>
                            <th>Plot</th>
                            <th>Booking Start Time</th>
                            <th>Booking End Time</th>
                            <th>Total Amount</th>
                        </tr>
                    `;

                    bookings.forEach(booking => {
                        const row = `
                            <tr>
                                <td>${booking.plot}</td>
                                <td>${booking.booking_start_time}</td>
                                <td>${booking.booking_end_time}</td>
                                <td>${booking.TotalAmount}</td>
                            </tr>
                        `;
                        table.innerHTML += row;
                    });
                }
            }

            // Function to fetch user's current bookings and populate the table
            function fetchUserCurrentBookings() {
                return fetch('/get_user_current_bookings') // Return the fetch promise
                    .then(response => response.json())
                    .then(data => {
                        console.log('Fetched bookings data:', data);
                        populateCurrentBookingsTable(data);
                    })
                    .catch(error => {
                        console.error('Error fetching user current bookings:', error);
                    });
            }

            // Call the function to fetch user's current bookings and populate the table
            fetchUserCurrentBookings().then(() => {
                // After fetching and populating, initialize the toggle
                toggleCurrentOrUpcomingBookings();
            });

            // Function to toggle the visibility of current bookings
            function toggleCurrentOrUpcomingBookings() {
                const toggleButton = document.getElementById('current-bookings-toggle');
                const currentBookingsContainer = document.getElementById('Current_bookings'); // Use the correct ID
                const arrowIcon = document.getElementById('current-bookings-arrow');

                toggleButton.addEventListener('click', function () {
                    if (currentBookingsContainer.style.display === 'none') {
                        currentBookingsContainer.style.display = 'block';
                        arrowIcon.classList.add('collapsed');
                    } else {
                        currentBookingsContainer.style.display = 'none';
                        arrowIcon.classList.remove('collapsed');
                    }
                });
                arrowIcon.addEventListener('click', function () {
                    if (currentBookingsContainer.style.display === 'block') {
                        currentBookingsContainer.style.display = 'none';
                        arrowIcon.classList.remove('collapsed');
                   }
                });

            }
        });
    </script>
</body>
</html>